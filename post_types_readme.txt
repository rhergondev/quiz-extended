# üìÅ Post Types - Sistema Modular

## üéØ Descripci√≥n General

El sistema de Post Types ha sido refactorizado de un archivo monol√≠tico de 2000+ l√≠neas a una **arquitectura modular** organizada, mantenible y escalable.

---

## üìÇ Estructura de Carpetas

```
includes/post-types/
‚îÇ
‚îú‚îÄ‚îÄ class-qe-post-types-loader.php    # üéõÔ∏è Loader principal (punto de entrada)
‚îú‚îÄ‚îÄ class-qe-post-types-base.php      # üß± Clase base abstracta para CPTs
‚îÇ
‚îú‚îÄ‚îÄ types/                              # üìù Definiciones de Custom Post Types
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-course-type.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-lesson-type.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-quiz-type.php
‚îÇ   ‚îî‚îÄ‚îÄ class-qe-question-type.php
‚îÇ
‚îú‚îÄ‚îÄ taxonomies/                         # üè∑Ô∏è Taxonom√≠as
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-taxonomy-base.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-category-taxonomy.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-provider-taxonomy.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-topic-taxonomy.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-difficulty-taxonomy.php
‚îÇ   ‚îî‚îÄ‚îÄ class-qe-course-type-taxonomy.php
‚îÇ
‚îú‚îÄ‚îÄ meta/                               # üîß Meta Fields (campos personalizados)
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-course-meta.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-lesson-meta.php
‚îÇ   ‚îú‚îÄ‚îÄ class-qe-quiz-meta.php
‚îÇ   ‚îî‚îÄ‚îÄ class-qe-question-meta.php
‚îÇ
‚îî‚îÄ‚îÄ validators/                         # ‚úÖ Validaci√≥n y Sanitizaci√≥n
    ‚îú‚îÄ‚îÄ class-qe-meta-validator.php
    ‚îî‚îÄ‚îÄ class-qe-step-sanitizer.php
```

---

## üöÄ C√≥mo Funciona

### **1. Inicializaci√≥n**

El sistema se inicializa en `class-qe-loader.php`:

```php
// Carga el loader modular
QE_Post_Types_Loader::instance()->init();
```

### **2. Flujo de Carga**

```
1Ô∏è‚É£ Loader Principal (class-qe-post-types-loader.php)
    ‚Üì
2Ô∏è‚É£ Carga clases base (Base, Taxonomy Base)
    ‚Üì
3Ô∏è‚É£ Carga Validators (antes de registro)
    ‚Üì
4Ô∏è‚É£ Carga Post Types (Course, Lesson, Quiz, Question)
    ‚Üì
5Ô∏è‚É£ Carga Taxonomies (Category, Provider, Topic, etc.)
    ‚Üì
6Ô∏è‚É£ Carga Meta Fields (Course Meta, Lesson Meta, etc.)
    ‚Üì
7Ô∏è‚É£ Registra todo en WordPress (hook 'init')
    ‚Üì
8Ô∏è‚É£ A√±ade mejoras REST API y capabilities
```

---

## üÜï Agregar Nuevo Post Type

### **Paso 1: Crear la clase del Post Type**

Crear archivo: `includes/post-types/types/class-qe-mi-tipo.php`

```php
<?php
class QE_Mi_Tipo_Type extends QE_Post_Types_Base
{
    public function __construct()
    {
        parent::__construct('mi_tipo');
    }

    protected function get_labels()
    {
        return [
            'name' => __('Mi Tipos', 'quiz-extended'),
            'singular_name' => __('Mi Tipo', 'quiz-extended'),
            // ... m√°s labels
        ];
    }

    protected function get_args()
    {
        $args = [
            'public' => true,
            'supports' => ['title', 'editor'],
            // ... m√°s args
        ];

        return array_merge(
            $args,
            $this->get_default_rest_args(),
            $this->get_default_capability_args()
        );
    }
}
```

### **Paso 2: Registrar en el Loader**

Editar `class-qe-post-types-loader.php` - m√©todo `load_post_types()`:

```php
$post_type_files = [
    'course' => 'types/class-qe-course-type.php',
    'lesson' => 'types/class-qe-lesson-type.php',
    'quiz' => 'types/class-qe-quiz-type.php',
    'question' => 'types/class-qe-question-type.php',
    'mi_tipo' => 'types/class-qe-mi-tipo.php', // ‚Üê NUEVO
];
```

### **Paso 3: Crear Meta Fields (opcional)**

Crear archivo: `includes/post-types/meta/class-qe-mi-tipo-meta.php`

```php
<?php
class QE_Mi_Tipo_Meta
{
    private $post_type = 'mi_tipo';

    public function register()
    {
        register_post_meta($this->post_type, '_mi_campo', [
            'show_in_rest' => true,
            'single' => true,
            'type' => 'string',
            'sanitize_callback' => 'sanitize_text_field',
        ]);
    }
}
```

Registrar en loader:

```php
$meta_files = [
    // ... otros
    'mi_tipo' => 'meta/class-qe-mi-tipo-meta.php',
];
```

---

## üîß Caracter√≠sticas Principales

### **‚úÖ Ventajas del Sistema Modular**

1. **Mantenibilidad**: Cada componente en su propio archivo
2. **Escalabilidad**: F√°cil agregar nuevos post types o taxonom√≠as
3. **Testeable**: Cada clase puede testearse independientemente
4. **Reutilizaci√≥n**: Clases base compartidas reducen c√≥digo duplicado
5. **Claridad**: Estructura clara y organizada
6. **Performance**: Carga solo lo necesario
7. **Compatibilidad**: Mantiene toda la funcionalidad existente

### **üîí Seguridad Integrada**

- **Validaci√≥n antes de guardar**: `QE_Meta_Validator` valida todos los datos
- **Sanitizaci√≥n espec√≠fica por tipo**: `QE_Step_Sanitizer` para lesson steps
- **Auth callbacks**: Verifica permisos en todos los meta fields
- **REST API authentication**: Control de acceso en endpoints

### **üì° REST API Enhancements**

- **Filtros por meta**: `/wp/v2/lesson?course_id=123`
- **Campos computados**: `enrolled_users_count`, `lessons_count`, etc.
- **Collection params**: Par√°metros adicionales de b√∫squeda
- **Autenticaci√≥n**: Control de acceso autom√°tico

---

## üìù Meta Fields por Post Type

### **Course Meta Fields**

```php
_start_date              // Fecha inicio (Y-m-d)
_end_date                // Fecha fin (Y-m-d)
_price                   // Precio (decimal)
_sale_price              // Precio oferta (decimal)
_duration_weeks          // Duraci√≥n en semanas (int)
_max_students            // M√°ximo estudiantes (int)
_difficulty_level        // Nivel: easy|medium|hard|beginner|intermediate|advanced
_product_type            // Tipo: free|paid
_woocommerce_product_id  // ID producto WooCommerce (int)
_lesson_ids              // Array de IDs de lecciones (array)

// Campos computados (REST API):
enrolled_users_count     // N√∫mero de usuarios inscritos
lessons_count            // N√∫mero de lecciones
is_free                  // Si el curso es gratis (bool)
```

### **Lesson Meta Fields**

```php
_course_id               // ID del curso padre (int)
_lesson_order            // Orden de la lecci√≥n (int)
_duration_minutes        // Duraci√≥n en minutos (int)
_lesson_description      // Descripci√≥n corta (string)
_completion_criteria     // Criterio: view|time|quiz|assignment
_is_preview              // Se puede ver sin pagar (bool)
_is_required             // Lecci√≥n obligatoria (bool)
_prerequisite_lessons    // Lecciones prerequisito (array)
_lesson_steps            // Steps de la lecci√≥n (array complejo)

// Campos computados:
steps_count              // N√∫mero de steps
```

### **Lesson Steps Structure**

```php
[
    [
        'type' => 'video|text|pdf|quiz|image|audio',
        'order' => 1,
        'title' => 'Step Title',
        'data' => [
            // Campos espec√≠ficos seg√∫n el tipo
        ]
    ],
    // ... m√°s steps
]
```

**Campos de data por tipo de step:**

- **Video**: `url`, `video_id`, `provider`, `duration`, `thumbnail`, `width`, `height`
- **Quiz**: `quiz_id`, `passing_score`, `max_attempts`, `time_limit`, `show_results`
- **Text**: `content`, `format`
- **PDF**: `file_id`, `url`, `filename`, `filesize`, `pages`, `allow_download`
- **Image**: `image_id`, `url`, `alt`, `caption`, `width`, `height`, `link`
- **Audio**: `audio_id`, `url`, `duration`, `title`, `artist`, `transcript`

### **Quiz Meta Fields**

```php
_course_id               // ID del curso padre (int)
_difficulty_level        // Nivel de dificultad (string)
_quiz_type               // Tipo: assessment|practice|exam
_time_limit              // L√≠mite de tiempo en minutos (int)
_max_attempts            // Intentos m√°ximos, 0=ilimitado (int)
_passing_score           // Puntuaci√≥n m√≠nima 0-100 (int)
_randomize_questions     // Aleatorizar preguntas (bool)
_show_results            // Mostrar resultados al finalizar (bool)
_enable_negative_scoring // Puntuaci√≥n negativa (bool)
_quiz_question_ids       // IDs de preguntas (array)
_lesson_ids              // IDs de lecciones donde aparece (array)

// Campos computados:
questions_count          // N√∫mero de preguntas
total_attempts           // Total de intentos realizados
```

### **Question Meta Fields**

```php
_course_id               // ID del curso (int)
_question_lesson         // ID de la lecci√≥n (int)
_question_type           // Tipo: multiple_choice|true_false|essay
_difficulty_level        // Nivel de dificultad (string)
_points                  // Puntos por respuesta correcta (int)
_points_incorrect        // Puntos negativos (int)
_question_order          // Orden de la pregunta (int)
_is_required             // Pregunta obligatoria (bool)
_quiz_ids                // IDs de quizzes que contienen esta pregunta (array)
_question_options        // Opciones de respuesta (array)
```

### **Question Options Structure**

```php
[
    [
        'id' => 1,
        'text' => 'Opci√≥n A',
        'isCorrect' => true
    ],
    [
        'id' => 2,
        'text' => 'Opci√≥n B',
        'isCorrect' => false
    ],
    // ... m√°s opciones
]
```

---

## üè∑Ô∏è Taxonom√≠as

### **qe_category** (Hierarchical)
- **Aplica a**: Course, Quiz, Question
- **Descripci√≥n**: Categorizaci√≥n compartida de contenido

### **qe_provider** (Non-Hierarchical)
- **Aplica a**: Question
- **Descripci√≥n**: Proveedor de la pregunta

### **qe_topic** (Hierarchical - Legacy)
- **Aplica a**: Course, Lesson, Quiz, Question
- **Descripci√≥n**: Temas del contenido

### **qe_difficulty** (Non-Hierarchical - Legacy)
- **Aplica a**: Course, Quiz, Question
- **Descripci√≥n**: Nivel de dificultad (redundante con meta field)

### **course_type** (Non-Hierarchical)
- **Aplica a**: Course
- **Descripci√≥n**: Tipo de curso

---

## ‚úÖ Validaci√≥n y Sanitizaci√≥n

### **QE_Meta_Validator**

Valida datos ANTES de guardar v√≠a REST API:

- **Courses**: Fechas, precios, productos WooCommerce
- **Lessons**: Relaciones, steps, prerequisitos
- **Quizzes**: Puntuaciones, preguntas
- **Questions**: Opciones, puntos

### **QE_Step_Sanitizer**

Sanitiza lesson steps seg√∫n su tipo:

```php
$sanitizer = new QE_Step_Sanitizer();
$clean_data = $sanitizer->sanitize($step_data, 'video');
```

M√©todos espec√≠ficos:
- `sanitize_video_step()`
- `sanitize_quiz_step()`
- `sanitize_text_step()`
- `sanitize_pdf_step()`
- `sanitize_image_step()`
- `sanitize_audio_step()`

---

## üîß Migraci√≥n desde el Sistema Antiguo

### **Pasos de Migraci√≥n**

1. **Backup de la base de datos** ‚úÖ
2. **Copiar nuevos archivos** a `includes/post-types/`
3. **Actualizar `class-qe-loader.php`** seg√∫n instrucciones
4. **Renombrar archivo antiguo** (no eliminar todav√≠a):
   ```bash
   mv includes/class-qe-post-types.php includes/class-qe-post-types.OLD.php
   ```
5. **Probar en desarrollo** primero
6. **Verificar funcionalidad**:
   - Post types registrados: `WP Admin > Posts`
   - REST API: `/wp-json/wp/v2/course`
   - Meta fields: Crear/editar contenido
7. **Eliminar archivo antiguo** despu√©s de confirmar

### **Compatibilidad**

‚úÖ **100% Compatible** - Mantiene:
- Todos los post types existentes
- Todos los meta fields
- Todas las taxonom√≠as
- REST API endpoints
- Capabilities
- Validaci√≥n y sanitizaci√≥n

‚ùå **Eliminado**:
- Post type `book` (no usado en el proyecto)

### **Rollback**

Si necesitas volver al sistema antiguo:

1. Restaurar `class-qe-post-types.php`
2. Revertir cambios en `class-qe-loader.php`
3. Eliminar carpeta `includes/post-types/`

---

## üêõ Debugging

### **Verificar Componentes Cargados**

```php
$loader = QE_Post_Types_Loader::instance();
$components = $loader->get_loaded_components();
print_r($components);
```

### **Ver Errores de Carga**

```php
$errors = $loader->get_loading_errors();
print_r($errors);
```

### **Logs**

Si `WP_DEBUG` y `WP_DEBUG_LOG` est√°n activos:

```
[Quiz Extended Post Types Loader INFO] Starting Post Types system initialization...
[Quiz Extended Post Types Loader INFO] Loading post types...
[Quiz Extended Post Types Loader INFO] Registered post type: course
...
```

### **Verificar Post Type Registrado**

```php
// En functions.php o mu-plugin
add_action('init', function() {
    $post_types = get_post_types(['_builtin' => false], 'objects');
    foreach ($post_types as $post_type) {
        if (strpos($post_type->name, 'course') !== false ||
            strpos($post_type->name, 'lesson') !== false ||
            strpos($post_type->name, 'quiz') !== false ||
            strpos($post_type->name, 'question') !== false) {
            error_log('QE Post Type: ' . $post_type->name . ' - ' . $post_type->label);
        }
    }
}, 999);
```

### **Verificar Meta Fields**

```php
$meta_keys = get_registered_meta_keys('post', 'course');
print_r($meta_keys);
```

---

## üìö Referencias

### **Clases Principales**

- `QE_Post_Types_Loader`: Orquestador principal
- `QE_Post_Types_Base`: Clase base para post types
- `QE_Taxonomy_Base`: Clase base para taxonom√≠as
- `QE_Meta_Validator`: Validaci√≥n de datos
- `QE_Step_Sanitizer`: Sanitizaci√≥n de steps

### **WordPress Codex**

- [register_post_type()](https://developer.wordpress.org/reference/functions/register_post_type/)
- [register_taxonomy()](https://developer.wordpress.org/reference/functions/register_taxonomy/)
- [register_post_meta()](https://developer.wordpress.org/reference/functions/register_post_meta/)
- [REST API Handbook](https://developer.wordpress.org/rest-api/)

---

## üë®‚Äçüíª Mantenimiento

### **Agregar Nuevo Meta Field**

1. Abrir archivo de meta correspondiente (ej: `class-qe-course-meta.php`)
2. A√±adir en el m√©todo apropiado (`register_numeric_fields()`, etc.)
3. Crear callback de sanitizaci√≥n si es necesario
4. Documentar en este README

### **Modificar Validaci√≥n**

1. Editar `class-qe-meta-validator.php`
2. Modificar m√©todo de validaci√≥n correspondiente
3. Probar con datos v√°lidos e inv√°lidos

### **Actualizar Labels/Args**

1. Editar clase del post type (ej: `class-qe-course-type.php`)
2. Modificar `get_labels()` o `get_args()`
3. Flush rewrite rules: `WP Admin > Settings > Permalinks > Save`

---

## üéâ Cr√©ditos

**Refactorizado por**: Equipo de Desarrollo
**Fecha**: 2025
**Versi√≥n**: 2.0.0

**Cambios principales**:
- ‚úÖ Arquitectura modular
- ‚úÖ Separaci√≥n de responsabilidades
- ‚úÖ Validaci√≥n robusta
- ‚úÖ Mejor mantenibilidad
- ‚úÖ Documentaci√≥n completa

---

## üìû Soporte

Si encuentras problemas con el sistema modular:

1. Verifica los logs de error
2. Comprueba que todos los archivos est√°n en su lugar
3. Revisa las instrucciones de migraci√≥n
4. Consulta la secci√≥n de debugging

**Rollback disponible** si es necesario volver al sistema antiguo.

---

**¬°Sistema Modular de Post Types v2.0 - Listo para Producci√≥n! üöÄ**